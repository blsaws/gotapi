<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  </head>

 <body>
  <h3>Editor</h3>
  <pre id="input" contenteditable>
  </pre>
	<button onClick="process();">Process text</button>
	<button onClick="process_table();">Process table</button>
	<pre id="output">
	</pre>
	<script type="text/javascript">
	function process_table() {
		dive = document.createElement("div");
		output = document.getElementById("output");
		input = document.getElementById("input").innerHTML;
		lines = input.split("\n");
		output.innerHTML = lines.length + " lines:\n";
		te = document.createElement("table");
		tce = document.createElement("caption");
		tce.innerHTML = "caption";
		te.appendChild(tce);
		hd = lines[0].split('\t');
		theade = document.createElement("thead");
		for (i=0;i<hd.length;i++) {
			the = document.createElement("th");
			the.innerHTML = hd[i];
			theade.appendChild(the);
		}
		te.appendChild(theade);
		for (i=1;i<lines.length;i++) {
			tre = document.createElement("tr");
			td = lines[i].split('\t');
			for (j=0;j<td.length;j++) {
				tde = document.createElement("td");
				tde.innerHTML = td[j];
				tre.appendChild(tde);
			}
			te.appendChild(tre);
		}
		dive.appendChild(te);
		output.innerHTML = print_xml(dive);
	}
	function process() {
		dive = document.createElement("div");
		output = document.getElementById("output");
		input = document.getElementById("input").innerHTML;
		lines = input.split("\n");
		output.innerHTML = lines.length + " lines:\n";
		sece = null; secs = []; ule = null; sule = null; ole = null;
		for (i=0;i<lines.length;i++) {
			if (lines[i].search(new RegExp("[0-9]"))==0) {
				if (sece !== null) dive.appendChild(sece);
				line = lines[i].split('\t');
				secnum = line[0];
				sece = document.createElement("section");
				sece.id = secnum;
				depth = secnum.split(".").length;
				he = document.createElement('h'+depth);
				he.innerHTML = line[1];
				sece.appendChild(he);
			}
			else if (lines[i].substring(0,2) == "â€¢	") {
				if (sule !== null) { ule.appendChild(sule); sule = null; }
				if (ule == null) ule = document.createElement("ul");
				lie = document.createElement("li");
				lie.innerHTML = lines[i].substring(2);
				ule.appendChild(lie);
			}
			else if (lines[i].substring(0,2) == "o	") {
				if (sule == null) sule = document.createElement("ul");
				lie = document.createElement("li");
				lie.innerHTML = lines[i].substring(2);
				sule.appendChild(lie);
			}
			else if (lines[i].charAt(0) == "(") {
				if (ole == null) ole = document.createElement("ol");
				lie = document.createElement("li");
				lie.innerHTML = lines[i].substring(lines[i].indexOf(' ')+1);
				ole.appendChild(lie);
			}
			else {
				if (sule !== null) { ule.appendChild(sule); sule = null; }
				if (ule !== null) { sece.appendChild(ule); ule = null; }
				if (ole !== null) { sece.appendChild(ole); ole = null; }
				if (lines[i].length > 0) {
					blank = true;
					for (j=0;j<lines[i].length;j++) { if (lines[i].charAt(j) !== ' ') blank = false; break; }
					if (!blank) {
						pe = document.createElement("p");
						pe.innerHTML = lines[i];
						if (sece !== null) sece.appendChild(pe);
						else dive.appendChild(pe);
						}
					}
			}
			output.innerHTML = print_xml(dive);
		}
		if (ule !== null) {	sece.appendChild(ule); ule = null; }
		if (ole !== null) {	sece.appendChild(ole); ole = null; }
		if (sece !== null) dive.appendChild(sece);
		output.innerHTML = print_xml(dive);
	}
	
process();
	
function xml2Str(xmlNode)
{
  try {
    // Gecko-based browsers, Safari, Opera.
    return (new XMLSerializer()).serializeToString(xmlNode);  }
  catch (e) {
    try {
      // Internet Explorer.
      return xmlNode.xml; }
    catch (e1)
    {//Strange Browser ??
     alert('Xmlserializer not supported'); }
  }
  return false;
}

function print_xml(xmlDoc) {
	var str = xml2Str(xmlDoc);
	var depth = -1; var i; var j;
	for (i = 0; i < str.length; i++) {
		if (str.charAt(i) == '>') {
			str = str.substring(0,i)  + "&gt;" + str.substring(i+1);
		}	
		if (str.substring(i, i+2) == '</') {
			depth--;
			if (str.charAt(i-1) == ';') { 
				str = str.substring(0,i) + "\n" + pad(depth) + "&lt;/" + str.substring(i+2);
			}
			else {
				str = str.substring(0,i) + "&lt;/" + str.substring(i+2);
			}
		}	
		if (str.charAt(i) == '<') {
			j = str.indexOf('>',i); 
			if (str.charAt(j-1) != '/') { 
				str = str.substring(0, i) + "\n" + pad(depth) + "&lt;" + str.substring(i+1);
				depth++; 
			}
			else {
				str = str.substring(0, i) + "\n" + pad(depth) + "&lt;" + str.substring(i+1,j) + "&gt;" + str.substring(j+1);
			}
		}	
	}
	return(str);
}

function pad(depth) {
	var padding = "";
	for (var j = 0; j < depth; j++) { padding = padding + "&nbsp;&nbsp;"; }
	return(padding);
}

  </script>
  </body>
</html>
